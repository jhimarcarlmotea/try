<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmakFit - Reports & Analytics</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Manrope:600,800|Inter:300,500,400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { font-family: 'Inter', Helvetica, sans-serif; margin: 0; padding: 0; background-color: #f8fafc; }
        
        .header-top { 
            background-color: #ffffff; 
            padding: 15px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000; 
            border-bottom: 1px solid #e2e8f0;
        }
        .header-top .container { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .logo-text { 
            font-family: "Inter", Helvetica; 
            font-weight: 700; 
            color: #1e3a8a; 
            font-size: 24px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-text i {
            color: #f59e0b;
            font-size: 26px;
        }
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .logout-btn { 
            padding: 8px 20px; 
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%); 
            border: none; 
            border-radius: 8px; 
            color: #000; 
            font-weight: 600; 
            font-size: 14px; 
            cursor: pointer; 
            transition: all 0.3s; 
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        .logout-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4); 
        }
        .account-circle { 
            width: 44px; 
            height: 44px; 
            cursor: pointer; 
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        .account-circle:hover {
            border-color: #f59e0b;
        }
        
        .nav-section { 
            background: linear-gradient(180deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%); 
            padding: 20px 0; 
            margin-top: 74px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        .nav-brand { 
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: "Manrope", Helvetica; 
            font-weight: 800; 
            font-size: 28px; 
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .nav-brand-logo {
            height: 60px;
            width: auto;
        }
        .nav-pills-custom { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            padding: 0; 
            margin: 0;
        }
        .nav-pills-custom .nav-link { 
            font-family: "Manrope", Helvetica; 
            font-weight: 600; 
            color: #000000; 
            font-size: 14px; 
            padding: 12px 18px;
            border-radius: 8px; 
            background-color: #ffffff; 
            transition: all 0.3s; 
            border: none; 
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-pills-custom .nav-link.active { 
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%); 
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }
        .nav-pills-custom .nav-link:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
        }
        
        .main-content { 
            background: linear-gradient(180deg, rgba(248, 250, 252, 1) 0%, rgba(241, 245, 249, 1) 100%); 
            padding: 40px 0 80px 0; 
            min-height: calc(100vh - 200px); 
        }

        .page-header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        .page-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .page-subtitle {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #64748b;
            font-size: 16px;
        }

        .filter-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #475569;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        .filter-select, .filter-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: "Inter", Helvetica;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-filter {
            padding: 10px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-export {
            padding: 10px 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Enhanced Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .stat-icon.total-students {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .stat-icon.active-students {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-icon.online-students {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-icon.tests-conducted {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .stat-icon i {
            font-size: 24px;
            color: white;
        }

        .stat-value {
            font-family: "Inter", Helvetica;
            font-weight: 800;
            color: #1e3a8a;
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-label {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #64748b;
            font-size: 14px;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Enhanced Monitoring Section */
        .monitoring-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        .monitoring-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .monitoring-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1f2937;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #10b981;
            font-size: 14px;
            background: #ecfdf5;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #d1fae5;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .monitoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .monitoring-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .monitoring-card-title {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #374151;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .student-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #f1f5f9;
            transition: all 0.3s;
        }

        .student-item:hover {
            background: #f8fafc;
            transform: translateX(4px);
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: 600;
            color: #64748b;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .student-details {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #64748b;
        }

        .student-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-online {
            color: #10b981;
        }

        .status-offline {
            color: #64748b;
        }

        .status-active {
            color: #3b82f6;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status-dot.online {
            background: #10b981;
        }

        .status-dot.offline {
            background: #64748b;
        }

        .status-dot.active {
            background: #3b82f6;
        }

        /* Charts Section */
        .chart-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1f2937;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        /* Table Section */
        .table-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #f8fafc;
        }

        .data-table th {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #64748b;
            font-size: 12px;
            text-transform: uppercase;
            padding: 14px 12px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #475569;
            font-size: 14px;
            padding: 16px 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        .data-table tr:hover {
            background-color: #f8fafc;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-excellent {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-good {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-fair {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-poor {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #475569;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.4;
        }

        .empty-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1f2937;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .empty-text {
            font-family: "Inter", Helvetica;
            font-weight: 400;
            color: #64748b;
            font-size: 14px;
            line-height: 1.6;
        }

        .umak-logo {
            height: 40px;
            width: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }

            .monitoring-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Analytics Dashboard...</div>
    </div>

    <div id="dashboardContent" style="display: none;">
        <div class="header-top">
            <div class="container">
                <div class="logo-text">
                    <img class="umak-logo" src="umaklogo.png" alt="University of Makati">
                    University of Makati
                </div>
                <div class="header-actions">
                    <button class="logout-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <img class="account-circle" src="https://c.animaapp.com/tzMzyNnw/img/icon.svg" alt="Account">
                </div>
            </div>
        </div>

        <div class="nav-section">
            <div class="container">
                <div class="nav-container">
                    <div class="nav-brand">
                        <img class="nav-brand-logo" src="logo.png" alt="UMakFit">
                        UMakFit
                    </div>
                    <ul class="nav nav-pills-custom">
                        <li class="nav-item">
                            <a class="nav-link" href="professor.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="classmanagement.html">
                                <i class="fas fa-users"></i> Class Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="testmanagement.html">
                                <i class="fas fa-calendar-alt"></i> Scheduling Test
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-chart-bar"></i> Reports & Analytics
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-chart-line" style="color: #3b82f6;"></i>
                        Reports & Analytics
                    </h1>
                    <p class="page-subtitle">Monitor student activity, track performance, and analyze test results</p>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">Section</label>
                            <select class="filter-select" id="filterSection">
                                <option value="">All Sections</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Test Name</label>
                            <select class="filter-select" id="filterTest">
                                <option value="">All Tests</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Date Range</label>
                            <select class="filter-select" id="filterDateRange">
                                <option value="all">All Time</option>
                                <option value="week">Last Week</option>
                                <option value="month">Last Month</option>
                                <option value="semester">This Semester</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-filter" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <button class="btn-export" onclick="exportReport()">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon total-students">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 5% from last month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon active-students">
                            <i class="fas fa-running"></i>
                        </div>
                        <div class="stat-value" id="activeStudents">0</div>
                        <div class="stat-label">Active Students Now</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 12% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon online-students">
                            <i class="fas fa-wifi"></i>
                        </div>
                        <div class="stat-value" id="onlineStudents">0</div>
                        <div class="stat-label">Students Online</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 8% from last week
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon tests-conducted">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="stat-value" id="totalTests">0</div>
                        <div class="stat-label">Tests Conducted</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 15% from last month
                        </div>
                    </div>
                </div>

                <!-- Enhanced Monitoring Section -->
                <div class="monitoring-section">
                    <div class="monitoring-header">
                        <h3 class="monitoring-title">
                            <i class="fas fa-desktop"></i>
                            Real-time Student Monitoring
                        </h3>
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span>Live Updates</span>
                        </div>
                    </div>
                    <div class="monitoring-grid">
                        <div class="monitoring-card">
                            <div class="monitoring-card-title">
                                <i class="fas fa-user-check" style="color: #10b981;"></i>
                                Total Active Students
                            </div>
                            <div class="student-list" id="activeStudentsList">
                                <!-- Active students will be populated here -->
                                <div class="empty-state">
                                    <div class="empty-icon">üë•</div>
                                    <div class="empty-title">No Active Students</div>
                                    <div class="empty-text">Students will appear here when they start tests</div>
                                </div>
                            </div>
                        </div>
                        <div class="monitoring-card">
                            <div class="monitoring-card-title">
                                <i class="fas fa-wifi" style="color: #3b82f6;"></i>
                                Students Online Now
                            </div>
                            <div class="student-list" id="onlineStudentsList">
                                <!-- Online students will be populated here -->
                                <div class="empty-state">
                                    <div class="empty-icon">üì±</div>
                                    <div class="empty-title">No Students Online</div>
                                    <div class="empty-text">Students will appear here when they log in</div>
                                </div>
                            </div>
                        </div>
                        <div class="monitoring-card">
                            <div class="monitoring-card-title">
                                <i class="fas fa-history" style="color: #f59e0b;"></i>
                                Recent Test Completions
                            </div>
                            <div class="student-list" id="recentCompletions">
                                <!-- Recent completions will be populated here -->
                                <div class="empty-state">
                                    <div class="empty-icon">‚úÖ</div>
                                    <div class="empty-title">No Recent Tests</div>
                                    <div class="empty-text">Completed tests will appear here</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-6">
                        <div class="chart-section">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="fas fa-chart-bar"></i>
                                    Test Performance Overview
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-section">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="fas fa-chart-pie"></i>
                                    Score Distribution
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="distributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Rankings & Performance Analysis -->
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="chart-section">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="fas fa-trophy"></i>
                                    Section Rankings & Performance Analysis
                                </h3>
                                <div class="live-indicator">
                                    <div class="live-dot"></div>
                                    <span>Updated Today</span>
                                </div>
                            </div>
                            
                            <!-- Section Performance Cards -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-3">
                                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                                            <i class="fas fa-trophy"></i>
                                        </div>
                                        <div class="stat-value" id="topSection">-</div>
                                        <div class="stat-label">Top Performing Section</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <div class="stat-value" id="avgSectionScore">0</div>
                                        <div class="stat-label">Average Section Score</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="stat-value" id="totalSections">0</div>
                                        <div class="stat-label">Total Sections</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                                            <i class="fas fa-percentage"></i>
                                        </div>
                                        <div class="stat-value" id="improvementRate">0%</div>
                                        <div class="stat-label">Overall Improvement</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Section Rankings Table -->
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Section Name</th>
                                            <th>Average Score</th>
                                            <th>Total Students</th>
                                            <th>Tests Completed</th>
                                            <th>Performance Trend</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sectionRankingsTable">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="empty-state">
                                                    <div class="empty-icon">üìä</div>
                                                    <div class="empty-title">Loading Section Rankings</div>
                                                    <div class="empty-text">Calculating section performance data...</div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Comparison Charts -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-6">
                        <div class="chart-section">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="fas fa-chart-bar"></i>
                                    Section Performance Comparison
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="sectionComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-section">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="fas fa-chart-pie"></i>
                                    Performance Distribution by Section
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="sectionDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Trends by Section -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            Section Performance Trends Over Time
                        </h3>
                        <div>
                            <select class="filter-select" id="trendSectionSelect" style="width: 200px;">
                                <option value="">All Sections</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="sectionTrendChart"></canvas>
                    </div>
                </div>

                <!-- Detailed Results Table -->
                <div class="table-section">
                    <div class="chart-header" style="margin-bottom: 20px;">
                        <h3 class="chart-title">
                            <i class="fas fa-table"></i>
                            Detailed Test Results
                        </h3>
                    </div>
                    <div id="resultsTableContainer">
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <div class="empty-title">No Data Available</div>
                            <div class="empty-text">Test results will appear here once students complete their assessments.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, orderBy, doc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentProfessor = null;
        let allResults = [];
        let charts = {
            performance: null,
            distribution: null,
            sectionComparison: null,
            sectionDistribution: null,
            sectionTrend: null
        };
        let assignedSections = [];
        let allStudents = [];

        // Section Performance Analysis Functions
        function analyzeSectionPerformance() {
            try {
                // Group results by section
                const sectionData = {};
                
                allResults.forEach(result => {
                    const section = result.section;
                    if (!section) return;
                    
                    if (!sectionData[section]) {
                        sectionData[section] = {
                            scores: [],
                            students: new Set(),
                            tests: new Set(),
                            testNames: new Set(),
                            dates: []
                        };
                    }
                    
                    const score = calculateTestScore(result.testName, result.result, result.testTarget);
                    if (score > 0) {
                        sectionData[section].scores.push(score);
                        sectionData[section].students.add(result.studentEmail || result.studentId || result.studentName);
                        sectionData[section].tests.add(result.testName);
                        sectionData[section].testNames.add(result.testName);
                        
                        // Add date for trend analysis
                        let date;
                        if (result.submittedAt && result.submittedAt.toDate) {
                            date = result.submittedAt.toDate();
                        } else if (result.date) {
                            date = new Date(result.date);
                        } else {
                            date = new Date();
                        }
                        sectionData[section].dates.push({ date, score, testName: result.testName });
                    }
                });

                // Calculate section statistics
                const sectionStats = [];
                Object.keys(sectionData).forEach(sectionName => {
                    const data = sectionData[sectionName];
                    const avgScore = data.scores.length > 0 ? 
                        Math.round(data.scores.reduce((a, b) => a + b, 0) / data.scores.length) : 0;
                    
                    // Calculate performance trend (last 5 tests vs previous 5)
                    let trend = 'stable';
                    if (data.scores.length >= 10) {
                        const recentScores = data.scores.slice(-5);
                        const previousScores = data.scores.slice(-10, -5);
                        const recentAvg = recentScores.reduce((a, b) => a + b, 0) / recentScores.length;
                        const previousAvg = previousScores.reduce((a, b) => a + b, 0) / previousScores.length;
                        
                        if (recentAvg > previousAvg + 5) trend = 'improving';
                        else if (recentAvg < previousAvg - 5) trend = 'declining';
                    }
                    
                    sectionStats.push({
                        name: sectionName,
                        averageScore: avgScore,
                        totalStudents: data.students.size,
                        testsCompleted: data.scores.length,
                        performanceTrend: trend,
                        testCount: data.testNames.size
                    });
                });

                // Sort sections by average score (descending)
                sectionStats.sort((a, b) => b.averageScore - a.averageScore);
                
                // Update section rankings display
                updateSectionRankings(sectionStats);
                
                // Update section performance cards
                updateSectionPerformanceCards(sectionStats);
                
                // Create comparison charts
                createSectionComparisonCharts(sectionStats, sectionData);
                
                // Setup section trend analysis
                setupSectionTrendAnalysis(sectionData);
                
            } catch (error) {
                console.error('Error analyzing section performance:', error);
            }
        }

        function updateSectionRankings(sectionStats) {
            const container = document.getElementById('sectionRankingsTable');
            
            if (sectionStats.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="empty-state">
                                <div class="empty-icon">üìä</div>
                                <div class="empty-title">No Section Data Available</div>
                                <div class="empty-text">Section rankings will appear here once students complete tests.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            sectionStats.forEach((section, index) => {
                const rank = index + 1;
                const trendIcon = section.performanceTrend === 'improving' ? 'üìà' : 
                                 section.performanceTrend === 'declining' ? 'üìâ' : '‚û°Ô∏è';
                const trendText = section.performanceTrend === 'improving' ? 'Improving' : 
                                 section.performanceTrend === 'declining' ? 'Declining' : 'Stable';
                const trendClass = section.performanceTrend === 'improving' ? 'text-success' : 
                                  section.performanceTrend === 'declining' ? 'text-danger' : 'text-warning';
                
                // Determine performance status
                let status = 'Excellent';
                let statusClass = 'badge-excellent';
                if (section.averageScore < 70) {
                    status = 'Needs Improvement';
                    statusClass = 'badge-poor';
                } else if (section.averageScore < 80) {
                    status = 'Fair';
                    statusClass = 'badge-fair';
                } else if (section.averageScore < 90) {
                    status = 'Good';
                    statusClass = 'badge-good';
                }
                
                html += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-2">${rank}</span>
                                ${rank <= 3 ? '<i class="fas fa-trophy text-warning"></i>' : ''}
                            </div>
                        </td>
                        <td>
                            <strong>${section.name}</strong>
                            <div class="small text-muted">${section.testCount} test types</div>
                        </td>
                        <td>
                            <strong class="fs-5">${section.averageScore}</strong>
                            <div class="small text-muted">out of 100</div>
                        </td>
                        <td>${section.totalStudents}</td>
                        <td>${section.testsCompleted}</td>
                        <td>
                            <span class="${trendClass}">
                                ${trendIcon} ${trendText}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateSectionPerformanceCards(sectionStats) {
            if (sectionStats.length === 0) return;
            
            // Top performing section
            const topSection = sectionStats[0];
            document.getElementById('topSection').textContent = topSection.name;
            
            // Average section score
            const totalScore = sectionStats.reduce((sum, section) => sum + section.averageScore, 0);
            const avgScore = Math.round(totalScore / sectionStats.length);
            document.getElementById('avgSectionScore').textContent = avgScore;
            
            // Total sections
            document.getElementById('totalSections').textContent = sectionStats.length;
            
            // Improvement rate (simulated)
            const improvementRate = Math.min(100, Math.floor(Math.random() * 20) + 5);
            document.getElementById('improvementRate').textContent = improvementRate + '%';
        }

        function createSectionComparisonCharts(sectionStats, sectionData) {
            createSectionComparisonChart(sectionStats);
            createSectionDistributionChart(sectionStats);
        }

        function createSectionComparisonChart(sectionStats) {
            const ctx = document.getElementById('sectionComparisonChart').getContext('2d');
            
            // Take top 8 sections for better visualization
            const displaySections = sectionStats.slice(0, 8);
            
            const sectionNames = displaySections.map(s => s.name);
            const averageScores = displaySections.map(s => s.averageScore);
            const studentCounts = displaySections.map(s => s.totalStudents);
            
            // Destroy existing chart if it exists
            if (charts.sectionComparison) {
                charts.sectionComparison.destroy();
            }
            
            charts.sectionComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sectionNames,
                    datasets: [
                        {
                            label: 'Average Score',
                            data: averageScores,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 2,
                            borderRadius: 8,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Student Count',
                            data: studentCounts,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: 'rgb(16, 185, 129)',
                            borderWidth: 2,
                            borderRadius: 8,
                            yAxisID: 'y1',
                            type: 'line',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Section Performance vs Student Count',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Average Score'
                            },
                            max: 100,
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Student Count'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        function createSectionDistributionChart(sectionStats) {
            const ctx = document.getElementById('sectionDistributionChart').getContext('2d');
            
            // Categorize sections by performance level
            const performanceLevels = {
                'Excellent (90-100)': 0,
                'Good (80-89)': 0,
                'Fair (70-79)': 0,
                'Needs Improvement (<70)': 0
            };
            
            sectionStats.forEach(section => {
                if (section.averageScore >= 90) performanceLevels['Excellent (90-100)']++;
                else if (section.averageScore >= 80) performanceLevels['Good (80-89)']++;
                else if (section.averageScore >= 70) performanceLevels['Fair (70-79)']++;
                else performanceLevels['Needs Improvement (<70)']++;
            });
            
            // Destroy existing chart if it exists
            if (charts.sectionDistribution) {
                charts.sectionDistribution.destroy();
            }
            
            charts.sectionDistribution = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(performanceLevels),
                    datasets: [{
                        data: Object.values(performanceLevels),
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Section Performance Distribution',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }

        function setupSectionTrendAnalysis(sectionData) {
            const select = document.getElementById('trendSectionSelect');
            
            // Clear and populate section dropdown
            select.innerHTML = '<option value="">All Sections</option>';
            Object.keys(sectionData).forEach(sectionName => {
                const option = document.createElement('option');
                option.value = sectionName;
                option.textContent = sectionName;
                select.appendChild(option);
            });
            
            // Create initial trend chart with all sections
            createSectionTrendChart(sectionData);
            
            // Add event listener for section selection
            select.addEventListener('change', function() {
                createSectionTrendChart(sectionData, this.value);
            });
        }

      function createSectionTrendChart(sectionData, selectedSection = null) {
            const ctx = document.getElementById('sectionTrendChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.sectionTrend) {
                charts.sectionTrend.destroy();
            }
            
            let labels = [];
            let datasets = [];
            
            if (selectedSection && sectionData[selectedSection]) {
                // Show bar chart for selected section only
                const section = sectionData[selectedSection];
                if (section && section.dates.length > 0) {
                    // Sort dates chronologically
                    const sortedDates = section.dates.sort((a, b) => a.date - b.date);
                    
                    // Group by test name and calculate average per test
                    const testAverages = {};
                    sortedDates.forEach(item => {
                        if (!testAverages[item.testName]) {
                            testAverages[item.testName] = { total: 0, count: 0 };
                        }
                        testAverages[item.testName].total += item.score;
                        testAverages[item.testName].count++;
                    });
                    
                    labels = Object.keys(testAverages);
                    const data = labels.map(testName => 
                        Math.round(testAverages[testName].total / testAverages[testName].count)
                    );
                    
                    datasets = [{
                        label: selectedSection,
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2,
                        borderRadius: 8
                    }];
                }
            } else {
                // Show bar chart for top 3 sections
                const topSections = Object.keys(sectionData)
                    .map(sectionName => ({
                        name: sectionName,
                        avgScore: sectionData[sectionName].scores.reduce((a, b) => a + b, 0) / sectionData[sectionName].scores.length
                    }))
                    .sort((a, b) => b.avgScore - a.avgScore)
                    .slice(0, 3);
                
                const colors = [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)'
                ];
                
                const borderColors = [
                    'rgb(59, 130, 246)',
                    'rgb(16, 185, 129)',
                    'rgb(245, 158, 11)'
                ];
                
                // Collect all unique test names
                const allTestNames = new Set();
                topSections.forEach(section => {
                    const sectionDataItem = sectionData[section.name];
                    sectionDataItem.dates.forEach(item => {
                        allTestNames.add(item.testName);
                    });
                });
                
                labels = Array.from(allTestNames);
                
                topSections.forEach((section, index) => {
                    const sectionDataItem = sectionData[section.name];
                    
                    // Calculate average score per test
                    const testAverages = {};
                    sectionDataItem.dates.forEach(item => {
                        if (!testAverages[item.testName]) {
                            testAverages[item.testName] = { total: 0, count: 0 };
                        }
                        testAverages[item.testName].total += item.score;
                        testAverages[item.testName].count++;
                    });
                    
                    const data = labels.map(testName => {
                        if (testAverages[testName]) {
                            return Math.round(testAverages[testName].total / testAverages[testName].count);
                        }
                        return 0;
                    });
                    
                    datasets.push({
                        label: section.name,
                        data: data,
                        backgroundColor: colors[index],
                        borderColor: borderColors[index],
                        borderWidth: 2,
                        borderRadius: 8
                    });
                });
            }
            
            if (datasets.length === 0 || labels.length === 0) {
                // Show empty state
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#64748b';
                ctx.textAlign = 'center';
                ctx.font = '16px Inter';
                ctx.fillText('No trend data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            charts.sectionTrend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: selectedSection ? 
                                `${selectedSection} Performance by Test` : 
                                'Top Sections Performance Comparison',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Average Score'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Test Name'
                            }
                        }
                    }
                }
            });
        }
        async function loadAnalyticsData() {
            try {
                // Load professor's assigned sections
                await loadAssignedSections();
                
                // Load all students in assigned sections
                await loadAllStudents();
                
                // Load test results
                await loadTestResults();
                
                // Load sections and tests for filters
                await loadFilters();
                
                // Calculate and display statistics
                calculateStatistics();
                
                // Update monitoring sections
                updateMonitoringSections();
                
                // Analyze section performance and rankings
                analyzeSectionPerformance();
                
                // Create charts
                createCharts();
                
                // Display results table
                displayResultsTable();
                
                // Set up real-time listeners
                setupRealTimeListeners();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadAssignedSections() {
            try {
                assignedSections = [];
                
                // Check professorProfiles collection
                const profileRef = doc(db, 'professorProfiles', currentProfessor.email);
                const profileDoc = await getDoc(profileRef);
                
                if (profileDoc.exists()) {
                    const profileData = profileDoc.data();
                    if (profileData.assignedClass) {
                        assignedSections.push({
                            id: profileData.assignedClass,
                            name: profileData.assignedClass,
                            professorEmail: currentProfessor.email
                        });
                    }
                }
                
                // Check sections collection by email
                const sectionsByEmailQuery = query(
                    collection(db, 'sections'), 
                    where('professorEmail', '==', currentProfessor.email)
                );
                const sectionsByEmailSnapshot = await getDocs(sectionsByEmailQuery);
                
                sectionsByEmailSnapshot.forEach((doc) => {
                    const sectionData = doc.data();
                    if (!assignedSections.find(s => s.name === sectionData.name)) {
                        assignedSections.push({
                            id: doc.id,
                            name: sectionData.name,
                            ...sectionData
                        });
                    }
                });
                
                // Check sections collection by UID
                const sectionsQuery = query(
                    collection(db, 'sections'), 
                    where('professorId', '==', currentProfessor.id)
                );
                const sectionsSnapshot = await getDocs(sectionsQuery);
                
                sectionsSnapshot.forEach((doc) => {
                    const sectionData = doc.data();
                    if (!assignedSections.find(s => s.name === sectionData.name)) {
                        assignedSections.push({
                            id: doc.id,
                            name: sectionData.name,
                            ...sectionData
                        });
                    }
                });
                
                console.log('Assigned sections:', assignedSections);
                
            } catch (error) {
                console.error('Error loading assigned sections:', error);
            }
        }

async function loadAllStudents() {
            try {
                allStudents = [];
                const studentIds = new Set(); // Track unique students by ID or email
                
                // Load students from all assigned sections
                for (const section of assignedSections) {
                    const studentsQuery = query(
                        collection(db, 'students'),
                        where('section', '==', section.name)
                    );
                    const studentsSnapshot = await getDocs(studentsQuery);
                    
                    studentsSnapshot.forEach((doc) => {
                        const studentData = doc.data();
                        const uniqueId = studentData.email || studentData.umakId || doc.id;
                        
                        // Only add if we haven't seen this student before
                        if (!studentIds.has(uniqueId)) {
                            studentIds.add(uniqueId);
                            allStudents.push({
                                id: doc.id,
                                ...studentData,
                                section: section.name,
                                uniqueId: uniqueId
                            });
                        }
                    });
                }
                
                console.log('Loaded unique students:', allStudents.length);
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }
        async function loadTestResults() {
            try {
                // Get all test results (without filtering by professor first to avoid index issues)
                const resultsQuery = query(
                    collection(db, 'testResults'),
                    orderBy('submittedAt', 'desc')
                );
                const resultsSnapshot = await getDocs(resultsQuery);
                
                allResults = [];
                resultsSnapshot.forEach(doc => {
                    const result = doc.data();
                    // Filter by professor email or assigned sections
                    if (result.professorEmail === currentProfessor.email || 
                        assignedSections.some(section => section.name === result.section)) {
                        allResults.push({ id: doc.id, ...result });
                    }
                });

                console.log('Loaded test results:', allResults.length);
                
            } catch (error) {
                console.error('Error loading test results:', error);
                // Fallback: try without ordering
                try {
                    const resultsSnapshot = await getDocs(collection(db, 'testResults'));
                    allResults = [];
                    resultsSnapshot.forEach(doc => {
                        const result = doc.data();
                        if (result.professorEmail === currentProfessor.email || 
                            assignedSections.some(section => section.name === result.section)) {
                            allResults.push({ id: doc.id, ...result });
                        }
                    });
                } catch (fallbackError) {
                    console.error('Fallback also failed:', fallbackError);
                }
            }
        }

        async function loadFilters() {
            const sectionsSet = new Set();
            const testsSet = new Set();
            
            allResults.forEach(result => {
                if (result.section) sectionsSet.add(result.section);
                if (result.testName) testsSet.add(result.testName);
            });

            const sectionSelect = document.getElementById('filterSection');
            const testSelect = document.getElementById('filterTest');
            
            // Clear existing options
            sectionSelect.innerHTML = '<option value="">All Sections</option>';
            testSelect.innerHTML = '<option value="">All Tests</option>';

            // Add assigned sections first
            assignedSections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.name;
                option.textContent = section.name;
                sectionSelect.appendChild(option);
            });

            // Add other sections from results
            sectionsSet.forEach(section => {
                if (!assignedSections.find(s => s.name === section)) {
                    const option = document.createElement('option');
                    option.value = section;
                    option.textContent = section;
                    sectionSelect.appendChild(option);
                }
            });

            testsSet.forEach(test => {
                const option = document.createElement('option');
                option.value = test;
                option.textContent = test;
                testSelect.appendChild(option);
            });
        }

        function calculateStatistics() {
            // Total students
            const totalStudents = allStudents.length;
            
            // Active students (simulated - in a real app, this would come from real-time data)
            const activeStudents = Math.min(totalStudents, Math.floor(Math.random() * 10) + 5);
            
            // Online students (simulated - in a real app, this would come from real-time data)
            const onlineStudents = Math.min(totalStudents, Math.floor(Math.random() * 15) + 10);
            
            // Total tests
            const totalTests = allResults.length;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('activeStudents').textContent = activeStudents;
            document.getElementById('onlineStudents').textContent = onlineStudents;
            document.getElementById('totalTests').textContent = totalTests;
        }

        function updateMonitoringSections() {
            updateActiveStudentsList();
            updateOnlineStudentsList();
            updateRecentCompletions();
        }

        function updateActiveStudentsList() {
            const container = document.getElementById('activeStudentsList');
            
            // Simulate active students (in a real app, this would come from real-time data)
            const activeStudents = allStudents
                .sort(() => 0.5 - Math.random())
                .slice(0, Math.min(5, allStudents.length));
            
            if (activeStudents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <div class="empty-title">No Active Students</div>
                        <div class="empty-text">Students will appear here when they start tests</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            activeStudents.forEach(student => {
                const firstName = student.firstName || 'Unknown';
                const lastName = student.lastName || 'Student';
                const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                
                html += `
                    <div class="student-item">
                        <div class="student-avatar">${initials}</div>
                        <div class="student-info">
                            <div class="student-name">${firstName} ${lastName}</div>
                            <div class="student-details">
                                <span>${student.section || 'N/A'}</span>
                                <span>ID: ${student.umakId || student.id.substring(0, 8)}</span>
                            </div>
                        </div>
                        <div class="student-status">
                            <div class="status-dot active"></div>
                            <span class="status-active">Active</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateOnlineStudentsList() {
            const container = document.getElementById('onlineStudentsList');
            
            // Simulate online students (in a real app, this would come from real-time data)
            const onlineStudents = allStudents
                .sort(() => 0.5 - Math.random())
                .slice(0, Math.min(8, allStudents.length));
            
            if (onlineStudents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì±</div>
                        <div class="empty-title">No Students Online</div>
                        <div class="empty-text">Students will appear here when they log in</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            onlineStudents.forEach(student => {
                const firstName = student.firstName || 'Unknown';
                const lastName = student.lastName || 'Student';
                const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                
                html += `
                    <div class="student-item">
                        <div class="student-avatar">${initials}</div>
                        <div class="student-info">
                            <div class="student-name">${firstName} ${lastName}</div>
                            <div class="student-details">
                                <span>${student.section || 'N/A'}</span>
                                <span>ID: ${student.umakId || student.id.substring(0, 8)}</span>
                            </div>
                        </div>
                        <div class="student-status">
                            <div class="status-dot online"></div>
                            <span class="status-online">Online</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateRecentCompletions() {
            const container = document.getElementById('recentCompletions');
            
            // Get recent test completions
            const recentCompletions = allResults
                .slice(0, Math.min(5, allResults.length));
            
            if (recentCompletions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <div class="empty-title">No Recent Tests</div>
                        <div class="empty-text">Completed tests will appear here</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            recentCompletions.forEach(result => {
                const studentName = result.studentName || 'Unknown Student';
                const testName = result.testName || 'Unknown Test';
                const score = calculateTestScore(result.testName, result.result, result.testTarget);
                
                // Get initials from student name
                const nameParts = studentName.split(' ');
                const initials = nameParts.length >= 2 
                    ? (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase()
                    : studentName.substring(0, 2).toUpperCase();
                
                html += `
                    <div class="student-item">
                        <div class="student-avatar">${initials}</div>
                        <div class="student-info">
                            <div class="student-name">${studentName}</div>
                            <div class="student-details">
                                <span>${testName}</span>
                                <span>Score: ${score}</span>
                            </div>
                        </div>
                        <div class="student-status">
                            <span>Completed</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function createCharts() {
            createPerformanceChart();
            createDistributionChart();
        }

        function createPerformanceChart() {
            const testScores = {};
            
            allResults.forEach(result => {
                if (!testScores[result.testName]) {
                    testScores[result.testName] = [];
                }
                const score = calculateTestScore(result.testName, result.result, result.testTarget);
                if (score > 0) {
                    testScores[result.testName].push(score);
                }
            });

            const testNames = Object.keys(testScores);
            const avgScores = testNames.map(test => {
                const scores = testScores[test];
                return scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            });

            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.performance) {
                charts.performance.destroy();
            }
            
            charts.performance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: testNames,
                    datasets: [{
                        label: 'Average Score',
                        data: avgScores,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        title: {
                            display: true,
                            text: 'Average Test Scores',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Score'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Test Name'
                            }
                        }
                    }
                }
            });
        }

        function createDistributionChart() {
            const scoreRanges = {
                'Excellent (90-100)': 0,
                'Good (80-89)': 0,
                'Fair (70-79)': 0,
                'Poor (<70)': 0
            };

            allResults.forEach(result => {
                const score = calculateTestScore(result.testName, result.result, result.testTarget);
                if (score >= 90) scoreRanges['Excellent (90-100)']++;
                else if (score >= 80) scoreRanges['Good (80-89)']++;
                else if (score >= 70) scoreRanges['Fair (70-79)']++;
                else if (score > 0) scoreRanges['Poor (<70)']++;
            });

            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.distribution) {
                charts.distribution.destroy();
            }
            
            charts.distribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(scoreRanges),
                    datasets: [{
                        data: Object.values(scoreRanges),
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Score Distribution',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }

        function displayResultsTable() {
            const container = document.getElementById('resultsTableContainer');
            
            if (allResults.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div class="empty-title">No Data Available</div>
                        <div class="empty-text">Test results will appear here once students complete their assessments.</div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Section</th>
                                <th>Test Name</th>
                                <th>Score</th>
                                <th>Rating</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Show only recent results (last 20)
            const recentResults = allResults.slice(0, 20);
            
            recentResults.forEach(result => {
                const score = calculateTestScore(result.testName, result.result, result.testTarget);
                const rating = getRating(score);
                let date;
                
                if (result.submittedAt && result.submittedAt.toDate) {
                    date = result.submittedAt.toDate();
                } else if (result.date) {
                    date = new Date(result.date);
                } else {
                    date = new Date(); // Fallback to current date
                }
                
                const dateStr = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });

                html += `
                    <tr>
                        <td>${result.studentName || 'Unknown Student'}</td>
                        <td>${result.section || 'N/A'}</td>
                        <td>${result.testName || 'N/A'}</td>
                        <td><strong>${score}</strong></td>
                        <td><span class="badge badge-${rating.class}">${rating.text}</span></td>
                        <td>${dateStr}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function calculateTestScore(testName, result, testTarget = null) {
            if (!testName || !result) return 0;
            
            const normalized = testName.toLowerCase();
            let numericValue = 0;

            // Extract numeric value from result
            if (typeof result === 'string') {
                const match = result.match(/(\d+\.?\d*)/);
                if (match) numericValue = parseFloat(match[1]);
            } else {
                numericValue = parseFloat(result) || 0;
            }

            // If professor set a target, use target-based scoring
            if (testTarget && testTarget > 0) {
                if (normalized.includes('push-up') || normalized.includes('pushup') || 
                    normalized.includes('sit-up') || normalized.includes('situp')) {
                    // For rep-based tests
                    const reps = parseInt(result);
                    if (reps >= testTarget) return 100;
                    if (reps >= testTarget * 0.9) return 95;
                    if (reps >= testTarget * 0.8) return 90;
                    if (reps >= testTarget * 0.7) return 85;
                    if (reps >= testTarget * 0.6) return 80;
                    if (reps >= testTarget * 0.5) return 75;
                    return Math.max(50, Math.round((reps / testTarget) * 100));
                } else if (normalized.includes('plank')) {
                    // For plank (time-based in seconds)
                    const seconds = parseInt(result.split(':')[1] || result);
                    if (seconds >= testTarget) return 100;
                    if (seconds >= testTarget * 0.9) return 95;
                    if (seconds >= testTarget * 0.8) return 90;
                    if (seconds >= testTarget * 0.7) return 85;
                    if (seconds >= testTarget * 0.6) return 80;
                    if (seconds >= testTarget * 0.5) return 75;
                    return Math.max(50, Math.round((seconds / testTarget) * 100));
                }
            }

            // Fallback to default scoring
            if (normalized.includes('push-up') || normalized.includes('pushup')) {
                const reps = numericValue;
                if (reps >= 40) return 100;
                if (reps >= 30) return 90;
                if (reps >= 20) return 80;
                if (reps >= 15) return 70;
                if (reps >= 10) return 60;
                return 50;
            } else if (normalized.includes('sit-up') || normalized.includes('situp')) {
                const reps = numericValue;
                if (reps >= 50) return 100;
                if (reps >= 40) return 90;
                if (reps >= 30) return 80;
                if (reps >= 20) return 70;
                if (reps >= 15) return 60;
                return 50;
            } else if (normalized.includes('plank')) {
                const seconds = numericValue;
                if (seconds >= 120) return 100;
                if (seconds >= 90) return 90;
                if (seconds >= 60) return 80;
                if (seconds >= 45) return 70;
                if (seconds >= 30) return 60;
                return 50;
            }

            return numericValue > 0 ? 75 : 0; // Default score for unknown tests
        }

        function getRating(score) {
            if (score >= 90) return { text: 'Excellent', class: 'excellent' };
            if (score >= 80) return { text: 'Good', class: 'good' };
            if (score >= 70) return { text: 'Fair', class: 'fair' };
            return { text: 'Poor', class: 'poor' };
        }

        function setupRealTimeListeners() {
            // In a real application, you would set up real-time listeners here
            // For now, we'll simulate updates with setInterval
            setInterval(() => {
                // Randomly update some statistics to simulate real-time changes
                const activeStudents = parseInt(document.getElementById('activeStudents').textContent);
                const onlineStudents = parseInt(document.getElementById('onlineStudents').textContent);
                
                // Small random fluctuations
                const newActive = Math.max(0, activeStudents + Math.floor(Math.random() * 3) - 1);
                const newOnline = Math.max(0, onlineStudents + Math.floor(Math.random() * 3) - 1);
                
                document.getElementById('activeStudents').textContent = newActive;
                document.getElementById('onlineStudents').textContent = newOnline;
                
                // Occasionally update the monitoring sections
                if (Math.random() < 0.3) {
                    updateMonitoringSections();
                }
            }, 10000); // Update every 10 seconds
        }

        window.applyFilters = function() {
            const section = document.getElementById('filterSection').value;
            const test = document.getElementById('filterTest').value;
            const dateRange = document.getElementById('filterDateRange').value;

            alert(`Filters applied:\n- Section: ${section || 'All'}\n- Test: ${test || 'All'}\n- Date Range: ${dateRange}`);
            
            // In a real implementation, this would filter the data and update the display
            // For now, we'll just show a message
        };

        window.exportReport = function() {
            if (allResults.length === 0) {
                alert('No data to export.');
                return;
            }

            alert('Report exported successfully! In a real implementation, this would download a CSV or PDF file.');
        };

        window.handleLogout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    currentProfessor = { id: user.uid, email: user.email };
                    await loadAnalyticsData();
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('dashboardContent').style.display = 'block';
                } catch (error) {
                    console.error('Error loading analytics:', error);
                    alert('Error loading analytics data');
                }
            } else {
                window.location.href = '/login/index.html';
            }
        });
    </script>
</body>
</html>